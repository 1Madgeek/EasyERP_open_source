var _ = require('lodash');
/**
 *  Represents a Filter Mapper constructor.
 *  Allow __You__ post `filter` generated by UI & then retrieve `filterObject` for mongoose.
 * @constructor
 */

var FilterMapper = function () {
    function ConvertType(array, type) {
        var result = {};

        switch (type) {
            case 'ObjectId':
                result['$in'] = array.objectID();
                break;
            case 'string':
                result['$in'] = array;
                break;
            case 'integer':
                result['$in'] = _.map(array, function (element) {
                    return parseInt(element);
                });
                break;
            case 'boolean':
                result['$in'] = _.map(array, function (element) {
                    if (element === 'true') {
                        return true;
                    }

                    return false;
                });
        }

        return result;
    };

    /**
     * @param {Object} filter Filter generated by UI.
     * @param {Object} filter.* Keys are model fields, like `country` or `outlet`.
     * @param {String} filter.*.type Type of filter values.
     * @param {Array} filter.*.values Array of filter values.
     * @return {Object} Returns query object.
     */

    this.mapFilter = function (filter) {
        var queryObject = {};
        var condition = '$and';
        var filterResult = [];
        var filterObject = {};
        var filterValues;
        var filterType;
        var filterBackend;

        if (filter.condition) {
            if (filter.condition === 'or') {
                condition = '$or';
            }
            delete filter.condition;
        }

        for (var filterName in filter) {
            filterValues = filter[filterName]['value'];
            filterType = filter[filterName]['type'];
            filterBackend = filter[filterName]['key'];

            filterObject[filterBackend] = ConvertType(filterValues, filterType);
            filterResult.push(filterObject);
        }

        queryObject[condition] = filterResult;

        return queryObject;
    };

};

module.exports = FilterMapper;